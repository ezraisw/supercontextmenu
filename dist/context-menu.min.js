"use strict";window.superCm=function(){function getOpts(cmIndex,actualOpts){var cm=cms[cmIndex];return cm.search.result&&!actualOpts?cm.search.result:cm.opts}function getOptContainer(cmIndex){return cms[cmIndex].element.find(".context-menu-options")}function getOptElements(cmIndex){return getOptContainer(cmIndex).children()}function getOptElement(cmIndex,optIndex){return getOptContainer(cmIndex).children().eq(optIndex)}function setCurrentActiveOver(cmIndex,optIndex){if(null==activeOpt||activeOpt.cmIndex!=cmIndex||activeOpt.optIndex!=optIndex){if(null!=activeOpt){let cmOptElement=getOptElement(activeOpt.cmIndex,activeOpt.optIndex);cmOptElement.hasClass("active")&&cmOptElement.removeClass("active")}if(cmIndex!=-1&&optIndex!=-1){let cmOptElement=getOptElement(cmIndex,optIndex);cmOptElement.hasClass("active")||cmOptElement.addClass("active"),activeOpt={cmIndex:cmIndex,optIndex:optIndex}}else activeOpt=null}}function setActiveOptSubmenu(cmIndex,optIndex){var activeSubmenu=cms[cmIndex].activeSubmenu;if(activeSubmenu!=optIndex){if(activeSubmenu!=-1){let cmOptElement=getOptElement(cmIndex,activeSubmenu);cmOptElement.hasClass("active-submenu")&&cmOptElement.removeClass("active-submenu")}if(optIndex!=-1){let cmOptElement=getOptElement(cmIndex,optIndex);cmOptElement.hasClass("active-submenu")||cmOptElement.addClass("active-submenu")}cms[cmIndex].activeSubmenu=optIndex}}function destroyCm(cmIndex){void 0===cmIndex&&(cmIndex=0),null!=activeOpt&&cmIndex<=activeOpt.cmIndex&&setCurrentActiveOver(-1,-1);for(let i=cms.length-1;i>=cmIndex;i--)cms.pop().element.remove()}function updateCm(cmIndex){var cm=cms[cmIndex],opts=getOpts(cmIndex,!1);0==opts.length&&(opts=[{label:"&lt; Empty &gt;",disabled:!0}]),opts.forEach(function(opt,optIndex){var cmOptElement=getOptElement(cmIndex,optIndex),separator=void 0!==opt.separator,icon=void 0!==opt.icon&&opt.icon,label=void 0!==opt.label&&opt.label,disabled=void 0!==opt.disabled&&opt.disabled,action=void 0!==opt.action&&opt.action,submenu=void 0!==opt.submenu&&opt.submenu;return cmOptElement.length?(cmOptElement.empty(),cmOptElement.off(),cmOptElement.removeClass()):(cmOptElement=cmOptTemplate.clone(),cmOptElement.appendTo(getOptContainer(cmIndex))),separator?(cmOptElement.hasClass("context-menu-separator")||cmOptElement.addClass("context-menu-separator"),void cmOptElement.append(optSeparatorTemplate.clone())):(icon&&cmOptElement.append(optIconTemplate.clone().addClass(opt.icon)),label&&cmOptElement.append(optTextTemplate.clone().html(opt.label)),disabled?void(cmOptElement.hasClass("context-menu-disabled")||cmOptElement.addClass("context-menu-disabled")):(action&&cmOptElement.click(function(){settings.autoClose?destroyCm():(destroyCm(cmIndex+1),setActiveOptSubmenu(cmIndex,-1)),opt.action(opt,cmIndex,optIndex)}),submenu?(cmOptElement.on("submenu",function(){if(cm.activeSubmenu!=optIndex){var submenuIndex=cmIndex+1;setActiveOptSubmenu(cmIndex,optIndex),destroyCm(submenuIndex),showCm(opt.submenu,submenuIndex,{x:cm.position.x+cm.element.outerWidth(),y:cm.position.y+this.offsetTop-this.parentElement.scrollTop-parseInt(cm.element.css("padding-top"))})}}),cmOptElement.mouseenter(function(){setCurrentActiveOver(cmIndex,optIndex),$(this).trigger("submenu")}),cmOptElement.hasClass("context-menu-submenu")||cmOptElement.addClass("context-menu-submenu")):(cmOptElement.mouseenter(function(){setCurrentActiveOver(cmIndex,optIndex),setActiveOptSubmenu(cmIndex,-1),destroyCm(cmIndex+1)}),cmOptElement.hasClass("context-menu-option")||cmOptElement.addClass("context-menu-option")),void cmOptElement.mouseleave(function(){activeOpt.cmIndex==cmIndex&&activeOpt.optIndex==optIndex&&setCurrentActiveOver(-1,-1)})))});var cmElementChildren=getOptElements(cmIndex);for(let i=cmElementChildren.length-1;i>=opts.length;i--)cmElementChildren.eq(i).remove()}function updateCmPosition(cmIndex,parentUpdate){var cm=cms[cmIndex];if(cmIndex>0){var parentCmIndex=cmIndex-1,parentCm=cms[parentCmIndex];if(parentUpdate){var activeSubmenu=getOptElement(parentCmIndex,parentCm.activeSubmenu);cm.position.x=parentCm.position.x+parentCm.element.outerWidth(),cm.position.y=activeSubmenu[0].offsetTop-parseInt(parentCm.element.css("padding-top"))}}var cmElementWidth=cm.element.outerWidth(),cmElementHeight=cm.element.outerHeight();if(cm.position.x-$(window).scrollLeft()+cmElementWidth>=$(window).innerWidth()&&(cm.position.x-=cmElementWidth,cmIndex>0&&(cm.position.x-=parentCm.element.outerWidth()),cm.position.x<$(window).scrollLeft()&&(cm.position.x=$(window).scrollLeft())),cm.position.y-$(window).scrollTop()+cmElementHeight>=$(window).innerHeight()){if(cm.position.y-=cmElementHeight,cmIndex>0){var paddingBottom=parseInt(cm.element.css("padding-bottom")),lastOpt=getOptElements(cmIndex).last(),paddingTop=parseInt(cm.element.css("padding-top"));cm.position.y+=paddingBottom+paddingTop+lastOpt.outerHeight()}cm.position.y<$(window).scrollTop()&&(cm.position.y=$(window).scrollTop())}if(cm.element.css("left",`${cm.position.x}px`),cm.element.css("top",`${cm.position.y}px`),null===settings.maxHeight){var leftoverHeight=cm.position.y-$(window).scrollTop();cm.element.css("max-height",`calc(100vh - ${leftoverHeight}px)`)}else cm.element.css("max-height",settings.maxHeight);null!==settings.minWidth&&cm.element.css("min-width",settings.minWidth),cm.element.css("z-index",settings.zIndex+cmIndex)}function populateSearchResult(result,opts,keyword){opts.forEach(function(opt){var match=!1;if(void 0!==opt.label&&opt.label){var label=opt.label.toLowerCase();label&&label.indexOf(keyword)!=-1&&(result.push(opt),match=!0)}!match&&void 0!==opt.submenu&&opt.submenu.length&&populateSearchResult(result,opt.submenu,keyword)})}function updateSearch(cmIndex,keyword){destroyCm(cmIndex+1);var cm=cms[cmIndex];if(""==keyword)return cm.search.result=null,void updateCm(cmIndex);setCurrentActiveOver(-1,-1);var result=[];populateSearchResult(result,cm.opts,keyword.toLowerCase()),cm.search.result=result,updateCm(cmIndex),updateCmPosition(cmIndex)}function showCm(opts,cmIndex,position){var cmElement=cmTemplate.clone();if(cmElement.find(".context-menu-options").scroll(function(){destroyCm(cmIndex+1)}),settings.searchBar&&0==cmIndex){var cmSearch=cmSearchTemplate.clone();cmSearch.prependTo(cmElement)}var cm={element:cmElement,position:position,opts:opts,activeSubmenu:-1,search:{result:null,input:cmSearch?cmSearch.find("input"):null}};cms.push(cm),setCurrentActiveOver(-1,-1),activeOpt={cmIndex:cmIndex,optIndex:-1},updateCm(cmIndex),cmElement.appendTo(document.body),updateCmPosition(cmIndex),cmSearch&&cm.search.input.on("input",function(){updateSearch(cmIndex,this.value.trim())}).focus()}function isSelectable(cmIndex,optIndex){var opt=getOpts(cmIndex,!1)[optIndex];return void 0===opt.separator&&(void 0===opt.disabled||!opt.disabled)}function findSuitableSelectable(cmIndex,optIndex,reverse){var optElements=getOptElements(cmIndex);optIndex>=optElements.length?optIndex=0:optIndex<0&&(optIndex=optElements.length-1);for(var currentOptIndex=optIndex;!isSelectable(cmIndex,currentOptIndex);){if((currentOptIndex+=reverse?-1:1)==optIndex)return-1;currentOptIndex>=optElements.length?currentOptIndex=0:currentOptIndex<0&&(currentOptIndex=optElements.length-1)}return currentOptIndex}function activeUp(){if(null==activeOpt||activeOpt.optIndex==-1){var cmIndex=cms.length-1,cmOpts=getOpts(cmIndex);if(cmOpts.length<=0)return;return void setCurrentActiveOver(cmIndex,cmOpts.length-1)}var previousOptIndex=findSuitableSelectable(activeOpt.cmIndex,activeOpt.optIndex-1,!0);previousOptIndex!=-1&&setCurrentActiveOver(activeOpt.cmIndex,previousOptIndex)}function activeDown(){if(null==activeOpt||activeOpt.optIndex==-1){var cmIndex=cms.length-1;if(getOpts(cmIndex).length<=0)return;return void setCurrentActiveOver(cmIndex,0)}var nextOptIndex=findSuitableSelectable(activeOpt.cmIndex,activeOpt.optIndex+1,!1);nextOptIndex!=-1&&setCurrentActiveOver(activeOpt.cmIndex,nextOptIndex)}var settings={minWidth:null,maxHeight:null,autoClose:!1,searchBar:!1,searchBarPlaceholder:"Search...",zIndex:50},cmTemplate=$("<div>").addClass("context-menu").append($("<div>").addClass("context-menu-options")),cmOptTemplate=$("<div>"),cmSearchTemplate=$("<div>").addClass("context-menu-search").append($("<input>").prop({type:"text",placeholder:settings.searchBarPlaceholder})),optIconTemplate=$("<i>").addClass("option-icon"),optTextTemplate=$("<span>").addClass("option-text"),optSeparatorTemplate=$("<hr>").addClass("option-separator"),cms=[],activeOpt=null;return $(document).on("mousedown contextmenu",".context-menu, .opt-text, .opt-icon, .opt-separator",function(e){e.stopPropagation()}),$(document).keydown(function(e){if("Escape"!=e.key&&27!=e.which||destroyCm(),cms.length>0)if("ArrowUp"==e.key||38==e.which)e.preventDefault(),activeUp();else if("ArrowDown"==e.key||40==e.which)e.preventDefault(),activeDown();else if("Enter"==e.key||13==e.which)e.preventDefault(),getOptElement(activeOpt.cmIndex,activeOpt.optIndex).click();else if("ArrowLeft"==e.key||37==e.which){if(null!=activeOpt&&activeOpt.cmIndex>0){e.preventDefault();var parentCmIndex=activeOpt.cmIndex-1,parentCm=cms[parentCmIndex],parentContextActiveSubmenu=parentCm.activeSubmenu;destroyCm(activeOpt.cmIndex),setActiveOptSubmenu(parentCmIndex,-1),setCurrentActiveOver(parentCmIndex,parentContextActiveSubmenu)}}else if(("ArrowRight"==e.key||39==e.which)&&null!=activeOpt&&activeOpt.optIndex!=-1){var optElement=getOptElement(activeOpt.cmIndex,activeOpt.optIndex);optElement.hasClass("context-menu-submenu")&&(e.preventDefault(),optElement.trigger("submenu"))}}),$(document).mousedown(function(){destroyCm()}),$(window).on("scroll resize",function(){destroyCm()}),{settings:settings,createMenu:function(opts,event){destroyCm(),showCm(opts,0,{x:event.pageX,y:event.pageY})},destroyMenu:function(){destroyCm()},updateMenu:function(){cms.forEach(function(cm,cmIndex){updateSearch(cmIndex,cm.search.input.val()),updateCm(cmIndex),updateCmPosition(cmIndex,!0)})},getMenuOptions:function(cmIndex){return cms[cmIndex].opts},addMenuOption:function(cmIndex,opt,optIndex){void 0!==optIndex?cms[cmIndex].opts.splice(optIndex,0,opt):cms[cmIndex].opts.push(opt)},addMenuOptions:function(cmIndex,opts,optIndex){void 0!==optIndex?cms[cmIndex].opts.splice(optIndex,0,...opts):cms[cmIndex].opts=cms[cmIndex].opts.concat(opts)},deleteMenuOption:function(cmIndex,optIndex){cms[cmIndex].opts.splice(optIndex,1)},setMenuOption:function(cmIndex,optIndex,opt){cms[cmIndex].opts[optIndex]=opt},setMenuOptions:function(cmIndex,opts){cms[cmIndex].opts=opts}}}();